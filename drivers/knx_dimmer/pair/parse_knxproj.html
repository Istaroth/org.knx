<!doctype html>
<div id="ets_input">
    <p data-i18n="settings.ets.body">
    </p>
    <fieldset>
        <legend>Upload project</legend>
        <div class="field row">
            <input id="file-input" accept="application/knxproj" type="file"/>
        </div>
        <button id="upload_button" class="right">Upload</button>
    </fieldset>
</div>

<script type="text/javascript" async=false defer=false src="parse_knxproj.assets/zip.js"></script>
<script type="text/javascript" async=false defer=false src="parse_knxproj.assets/zip-ext.js"></script>
<script type="text/html" id="devices-list-template">
    <li class="device">
        <label for='device-{{:mac}}' class="name">
            <div class="overlay"></div>
            <input class="name" value="{{:name}}" tabindex="-1" />
        </label>
    </li>
</script>
<script>
    Homey.setTitle('Upload a ETS project file');
	function onerror(message) {
		console.error(message);
	}

	var model =  {
        getEntries : function(file, callback) {
            console.log('getEntries');
            zip.createReader(new zip.BlobReader(file), function(zipReader) {
                zipReader.getEntries(callback);
            }, onerror);
        },
        getEntryFile : function(entry, callback) {
            console.log('getEntryFile');
            var writer = new zip.TextWriter();
            entry.getData(writer, function(text) {
                callback(text);
            });
        }
    };

    function extractParseProjectFile(entry, li, a) {
        model.getEntryFile(entry, function(rawXML) {
            var parser = new DOMParser();
            parsedXMLData = parser.parseFromString(rawXML, "application/xml");
            console.log(parsedXMLData);
            // Parsing of ETS project file starts here
            Homey.showView('list_groupaddresses');
        });
    }

    var fileInput = document.getElementById("file-input");
    console.log(fileInput);

    fileInput.addEventListener('change', function() {
        console.log('file nput changed');
        fileInput.disabled = true;
        model.getEntries(fileInput.files[0], function(entries) {
            entries.forEach(function(entry) {
                if (entry.filename.match(/\/0\.xml$/i)) {
                    console.log('0.xml found with regex', entry.filename);
                    extractParseProjectFile(entry);
                }
            });
        });
    }, false);
</script>