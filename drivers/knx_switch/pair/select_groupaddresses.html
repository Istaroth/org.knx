<!doctype html>
<div id="ga_input">
    <p data-i18n="settings.groupaddresses.body">
    </p>
    <fieldset>
        <div class="field row">
            <label for="toggle_address" class="left" data-i18n="settings.groupaddresses.switch.toggle"></label>
            <input id="toggle_address" type="text" class="right">
            <select id="switchga_dropdown"></select>
            <label for="status_address" class="left" data-i18n="settings.groupaddresses.switch.status"></label>
            <input id="status_address" type="text" class="right">
            <select id="switchstatusga_dropdown"></select>
        </div>
    </fieldset>
    <fieldset>
        <div class="field row">
            <label for="dim_address" class="left" data-i18n="settings.groupaddresses.dimmer.value"></label>
            <input id="dim_address" type="text" class="right">
            <select id="dimga_dropdown"></select>
            <label for="dim_status_address" class="left" data-i18n="settings.groupaddresses.dimmer.status"></label>
            <input id="dim_status_address" type="text" class="right">
            <select id="dim_statusga_dropdown"></select>
        </div>
    </fieldset>
    <label id=xmltext data-i18n="settings.configmode.newxml.explanation"></label>
    <button id="button_newxml" class="right" data-i18n="settings.configmode.newxml.title"></button>
    <label id="learnmode_label" data-i18n="settings.configmode.learnmode.explanation"></label>
    <button id="learnmode_button" class="right" data-i18n="settings.configmode.learnmode.title"></button>
    <select id="learnmode_dropdown" style="display: none"></select>
    <button id="test_button" class="right">TEST</button>
    <button id="save_button" class="right">Save device</button>
</div>
<script>
    Homey.setTitle(Homey.__('Groupaddresses.... Groupaddresses everywhere!'));
    // Global variables
    var interfaceMAC;
    var switchGA = '';
    var groupAddresses;
    Homey.emit('return_selected_interface', function(error, macAddress) {
        interfaceMAC = macAddress;
        console.log('MAC:', interfaceMAC);
    });
    // Buttons
    var $learnmodeButton = $('#learnmode_button');
    var $newXMLButton = $('#button_newxml');
    var $testButton = $("#test_button");
    var $saveButton = $("#save_button");

    // Fields
    var $toggleAddressField = $("#toggle_address");

    // Dropdowns
    var $switchGADropdown = document.getElementById("switchga_dropdown");
    var $switchGADropdownClicker = $('#switchga_dropdown');
    var $switchStatusGADropDown = document.getElementById("switchstatusga_dropdown");
    var $dimGADropdown = document.getElementById("dimga_dropdown");
    var $dimStatusGADropdown = document.getElementById("dim_statusga_dropdown");

    var $learnmodeDropdown = document.getElementById("learnmode_dropdown");
    var $xmlText = $('#xmltext');

    // Helper functions

    function listGroupAddressesDropdown(selectItem, filter) {
        groupAddresses.forEach(function(etsEntry) {
            var optionEl = document.createElement("option");
            optionEl.value = etsEntry.address;
            optionEl.textContent = etsEntry.name + ", groupaddress: " + etsEntry.address;
            selectItem.appendChild(optionEl);
        })
    }

    // Button acctions
    $newXMLButton.on('click', function() {
        Homey.showView('parse_knxproj')
    });

    $switchGADropdownClicker.on('click', function() {
        $toggleAddressField[0].text = switchGADropdown.value;
    });

    $learnmodeButton.on('click', function() {
        $learnmodeDropdown.innerHTML = "";
        Homey.emit('learnmode', function(error, filteredList) {
            if(filteredList && filteredList.length > 0) {
                console.log('learnmode list', filteredList);
                filteredList.forEach(function(event) {
                    var optionEl = document.createElement("option");
                    optionEl.value = event.destination;
                    optionEl.textContent = "Groupaddress " + event.destination;
                    $learnmodeDropdown.appendChild(optionEl);
                });
                $("#learnmode_dropdown").css("display", "block");
            }
        });
    });

    $testButton.on('click', function() {
        Homey.emit('test_groupaddress', $learnmodeDropdown.value, function(error, result) {
            console.log(result);
        });
        switchGA = $learnmodeDropdown.value;
    });

    $saveButton.on('click', function() {
        if(interfaceMAC) {
            console.log('Saving this device');
            if (!switchGA) {
                switchGA = $switchGADropdown.value;
            }
            Homey.addDevice({
                data: {
                    id: switchGA
                },
                name: 'KNX device',
                settings: { 'ga_switch': switchGA,
                            'ga_status' : $switchStatusGADropDown.value,
                            'macAddress': interfaceMAC
                },
            }, function(err, result){
                if(err) return Homey.alert(err);
                Homey.done();
            });
        } else {
            console.log('Cannot save device, no MAC address');
        }
    })

    // Check if there are uploaded groupaddresses available
    Homey.emit('list_etsimport', function(error, groupAddressList) {
        if(groupAddressList && groupAddressList.length > 0) {
            groupAddresses = groupAddressList;
            console.log(groupAddressList);
            console.log($xmlText);
            $xmlText[0].textContent = "A ETS export has already been uploaded for this interface.";
            listGroupAddressesDropdown($switchGADropdown);
            listGroupAddressesDropdown($switchStatusGADropDown);
            listGroupAddressesDropdown($dimGADropdown);
            listGroupAddressesDropdown($dimStatusGADropdown);
        }
    });
</script>