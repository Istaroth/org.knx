<style type="text/css">
.knx-wrap fieldset select,
.knx-wrap fieldset input[type="text"] {
	max-width: 200px;
	float: right;
	margin-left: 0.4em;
}
.knx-wrap fieldset .row label {
	width: auto;
}
.knx-wrap fieldset input[type="text"] {
	max-width: 70px;
}
.knx-wrap fieldset select {
	display: none;
}
.knx-wrap .knx-entry {
	overflow: hidden;
}
.knx-wrap .knx-entry:not(:last-child) {
	padding-bottom: 0.4em;	
}
</style>
<div class="knx-wrap" id="ga_input">
    <p data-i18n="settings.groupaddresses.body">
    </p>
    <fieldset id="knx-light-fieldset" style="display: none">
        <div class="knx-light field row">
	        <div class="knx-entry">
        	    <label for="toggle_address" class="left" data-i18n="settings.groupaddresses.switch.toggle"></label>
    	        <select id="light_ga_dropdown" class="knx-dropdown"></select>
	            <input id="toggle_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
	        <div class="knx-entry">
	            <label for="toggle_status_address" class="left" data-i18n="settings.groupaddresses.generic_status"></label>
	            <select id="statusga_dropdown" class="knx-dropdown"></select>
	            <input id="toggle_status_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-switch-fieldset" style="display: none">
        <div class="knx-switch field row">
	        <div class="knx-entry">
        	    <label for="switch_toggle_address" class="left" data-i18n="settings.groupaddresses.switch.toggle"></label>
    	        <select id="switchga_dropdown" class="knx-dropdown"></select>
	            <input id="switch_toggle_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-dimmer-fieldset" style="display: none">
        <div class="knx-dimmer field row">
	        <div class="knx-entry">
	            <label for="dim_address" class="left" data-i18n="settings.groupaddresses.dimmer.value"></label>
            	<select id="dimga_dropdown" class="knx-dropdown"></select>
        	    <input id="dim_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
	        <div class="knx-entry" id="knx-dimmer-status-entry">
    	        <label for="dim_status_address" class="left" data-i18n="settings.groupaddresses.dimmer.status"></label>
	            <select id="dim_statusga_dropdown" class="knx-dropdown"></select>
				<input id="dim_status_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-rgb-fieldset" style="display: none">
        <div class="knx-rgb field row">
	        <div class="knx-entry">
        	    <label for="red_toggle_label" class="left" data-i18n="settings.groupaddresses.rgb.red_toggle_action"></label>
    	        <select id="red_toggle_dropdown" class="knx-dropdown"></select>
	            <input id="red_toggle_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
    	        <label for="red_toggle_status_label" class="left" data-i18n="settings.groupaddresses.rgb.red_toggle_status"></label>
	            <select id="red_toggle_status_dropdown" class="knx-dropdown"></select>
				<input id="red_toggle_status_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
        	    <label for="red_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.red_dim_value"></label>
    	        <select id="red_dim_dropdown" class="knx-dropdown"></select>
	            <input id="red_dim_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
        	    <label for="red_dim_status_label" class="left" data-i18n="settings.groupaddresses.rgb.red_dim_status"></label>
    	        <select id="red_dim_status_dropdown" class="knx-dropdown"></select>
	            <input id="red_dim_status_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
        <div class="knx-rgb field row">
	        <div class="knx-entry">
            	<label for="green_toggle_label" class="left" data-i18n="settings.groupaddresses.rgb.green_toggle_action"></label>
				<select id="green_toggle_dropdown" class="knx-dropdown"></select>
				<input id="green_toggle_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
            	<label for="green_toggle_status_label" class="left" data-i18n="settings.groupaddresses.rgb.green_toggle_status"></label>
				<select id="green_toggle_status_dropdown" class="knx-dropdown"></select>
				<input id="green_toggle_status_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
        	    <label for="green_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.green_dim_value"></label>
    	        <select id="green_dim_dropdown" class="knx-dropdown"></select>
	            <input id="green_dim_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
	            <label for="green_dim_status_label" class="left" data-i18n="settings.groupaddresses.rgb.green_dim_status"></label>
				<select id="green_dim_status_dropdown" class="knx-dropdown"></select>
				<input id="green_dim_status_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
			</div>
        </div>
        <div class="knx-rgb field row">
	        <div class="knx-entry">
        	    <label for="blue_toggle_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_toggle_action"></label>
    	        <select id="blue_toggle_dropdown" class="knx-dropdown"></select>
	            <input id="blue_toggle_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
            	<label for="blue_toggle_status_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_toggle_status"></label>
				<select id="blue_toggle_status_dropdown" class="knx-dropdown"></select>
				<input id="blue_toggle_status_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
	            <label for="blue_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_dim_value"></label>
				<select id="blue_dim_dropdown" class="knx-dropdown"></select>
				<input id="blue_dim_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
	        </div>
	        <div class="knx-entry">
	            <label for="blue_dim_status_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_dim_status"></label>
				<select id="blue_dim_status_dropdown" class="knx-dropdown"></select>
				<input id="blue_dim_status_input" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-thermostat-fieldset" style="display: none">
        <div class="knx-thermostat field row">
	        <div class="knx-entry">
	            <label for="temperature_target_address" class="left" data-i18n="settings.groupaddresses.thermostat.target"></label>
            	<select id="temperature_target_ga_dropdown" class="knx-dropdown"></select>
        	    <input id="temperature_target_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
	        <div class="knx-entry">
    	        <label for="temperature_measure_address" class="left" data-i18n="settings.groupaddresses.thermostat.measure"></label>
	            <select id="temperature_measure_ga_dropdown" class="knx-dropdown"></select>
				<input id="temperature_measure_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-windowcovering-fieldset" style="display: none">
        <div class="knx-windowcovering field row">
	        <div class="knx-entry">
	            <label for="windowcover_updown_address" class="left" data-i18n="settings.groupaddresses.windowcovering.updown"></label>
            	<select id="windowcover_updown_ga_dropdown" class="knx-dropdown"></select>
        	    <input id="windowcover_updown_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
	        <div class="knx-entry">
    	        <label for="windowcover_stop_address" class="left" data-i18n="settings.groupaddresses.windowcovering.stop"></label>
	            <select id="windowcover_stopga_dropdown" class="knx-dropdown"></select>
				<input id="windowcover_stop_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
            <div class="knx-entry">
    	        <label for="windowcover_status_address" class="left" data-i18n="settings.groupaddresses.generic_status"></label>
	            <select id="windowcover_statusga_dropdown" class="knx-dropdown"></select>
				<input id="windowcover_status_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-sensor-fieldset" style="display: none">
        <div class="knx-sensor field row">
            <div class="knx-entry">
                <label for="sensor_address" class="left" data-i18n="settings.groupaddresses.sensor"></label>
                <select id="sensor_ga_dropdown" class="knx-dropdown"></select>
                <input id="sensor_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-scene-fieldset" style="display: none">
        <div class="knx-scene field row">
            <div class="knx-entry">
                <label for="scene_address" class="left" data-i18n="settings.groupaddresses.scene"></label>
                <select id="scene_ga_dropdown" class="knx-dropdown"></select>
                <input id="scene_address" type="text" class="knx-text right" placeholder="e.g. 0/1/2" />
            </div>
        </div>
        <div class="knx-scene field row">
            <div class="knx-entry">
                <label for="scene_number" class="left" data-i18n="settings.scene_number"></label>
                <input id="scene_number" type="text" class="knx-text right" placeholder="e.g. 8" />
            </div>
        </div>
    </fieldset>
    <fieldset id="knx-learnmode-fieldset" style="display: none">
        <label id="learnmode_label" data-i18n="settings.learnmode.explanation"></label>
        <button id="learnmode_button" class="right" data-i18n="settings.learnmode.title"></button>
        <select id="learnmode_dropdown" style="display: none"></select>
        <button id="test_button" class="right" style="display: none;" data-i18n="settings.learnmode.testbutton"></button>
    </fieldset>
    <p id="xmltext" data-i18n="settings.projectfile.newxml.explanation"></p>
    <button id="save_button" class="right" data-i18n="settings.groupaddresses.save"></button>
</div>
<script>
    Homey.setTitle(Homey.__("settings.groupaddresses.body"));
    // Global variables
    var deviceType;
    var deviceUuid; //const?
    var interfaceMAC;
    var groupAddresses;

    Homey.emit('return_selected_interface', function(error, macAddress) {
        interfaceMAC = macAddress;
    });

    Homey.emit('get_uuid', function(error, uuid) {
        deviceUuid = uuid;
    });

    Homey.getOptions(function(err, options) {
       deviceType = options.devicetype;
    });

    switch(deviceType) {
        case 'light':
            console.log('device is a light');
            $("#knx-light-fieldset").css("display", "block");
            break;
        case 'switch':
            console.log('device is a switch');
            $("#knx-switch-fieldset").css("display", "block");
            $("#knx-learnmode-fieldset").css("display", "block");
            break;
        case 'dimmer':
            console.log('device is a dimmer');
            $("#knx-light-fieldset").css("display", "block");
            $("#knx-dimmer-fieldset").css("display", "block");
            break;
        case 'dimcontrol':
            console.log('device is a dimcontrol');
            $("#knx-light-fieldset").css("display", "block");
            $("#knx-dimmer-fieldset").css("display", "block");
            $("#knx-dimmer-status-entry").css("display", "none");
            break;
        case 'rgb':
            console.log('device is a rgb');
            $("#knx-rgb-fieldset").css("display", "block");
            break;
        case 'thermostat':
            console.log('device is a thermostat');
            $("#knx-thermostat-fieldset").css("display", "block");
            break;
        case 'windowcovering':
            console.log('device is a windowcovering');
            $("#knx-windowcovering-fieldset").css("display", "block");
            break;
        case 'sensor':
            console.log('device is a sensor');
            $("#knx-sensor-fieldset").css("display", "block");
            break;
        case 'scene':
            console.log('device is a scene');
            $("#knx-scene-fieldset").css("display", "block");
            break;
    }

    $learnmodeDropdown = $('#learnmode_dropdown');
    $learnmodeButton = $('#learnmode_button');
    $testButton = $('#test_button');

    var $xmlText = $('#xmltext');

    // Helper functions

    function listGroupAddressesDropdown(selectItem, filter) {
        groupAddresses.forEach(function(etsEntry) {
            var optionEl = document.createElement("option");
            optionEl.value = etsEntry.address;
            optionEl.textContent = etsEntry.name + Homey.__('settings.groupaddresses.pairing_list') + etsEntry.address;
            $(selectItem).append(optionEl);
        })
        $(selectItem).toggle(!!groupAddresses.length)
    }

    $('.knx-dropdown').on('change', function() {
        var value = $(this).val();
        $(this).next('.knx-text').val(value);
    })

    $learnmodeButton.on('click', function() {
	    $learnmodeButton.attr('disabled', 'disabled');
        $learnmodeDropdown.innerHTML = "";
        Homey.emit('learnmode', function(error, filteredList) {
	        if(error) return Homey.alert(Homey.__('errors.generic_error'), error.message || error.toString(), 'error' );
	        
		    $learnmodeButton.removeAttr('disabled');
            if (filteredList && filteredList.length > 0) {
                filteredList.forEach(function(event) {
                    var optionEl = document.createElement("option");
                    optionEl.value = event.destination;
                    optionEl.textContent = Homey.__('settings.groupaddresses.generic') + event.destination;
                    $learnmodeDropdown.append(optionEl);
                });
                $learnmodeDropdown.toggle(!!filteredList.length);
                $testButton.toggle(!!filteredList.length);
                $("#switch_toggle_address").val($learnmodeDropdown.val());
            } else {
                Homey.alert(Homey.__('settings.learnmode.no_result'), 'info');
            }
        });
    });

    $learnmodeDropdown.on('change', function() {
        $("#switch_toggle_address").val($learnmodeDropdown.val());
    });

    $testButton.on('click', function() {
        $testButton.attr('disabled', 'disabled');
        var testTimeMs = 3200;
        Homey.emit('test_groupaddress', {address: $learnmodeDropdown.val(), time: testTimeMs}, function(error, result) {
            if(error) Homey.alert(error);
            setTimeout(function() {
                $testButton.removeAttr('disabled');
            }, testTimeMs);
        });
        $("#toggle_address").val($learnmodeDropdown.val());
    });

    $("#save_button").on('click', function() {
        if(interfaceMAC) {
            console.log('Saving this device');
 
            switch(deviceType) {
                case 'light':
                    Homey.addDevice({
                        data: {
                           id: deviceUuid
                        },
                        name: 'KNX Light',
                        settings: { 'ga_switch': $("#toggle_address").val(),
                                    'ga_status': $("#toggle_status_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'switch':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX Switch',
                        settings: { 'ga_switch': $("#switch_toggle_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'dimmer':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX Dimmer',
                        settings: { 'ga_switch': $("#toggle_address").val(),
                                    'ga_status': $("#toggle_status_address").val(),
                                    'ga_dim': $("#dim_address").val(),
                                    'ga_dim_status': $("#dim_status_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'dimcontrol':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX Relative Dimmer',
                        settings: { 'ga_switch': $("#toggle_address").val(),
                                    'ga_status': $("#toggle_status_address").val(),
                                    'ga_dim': $("#dim_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'rgb':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX RGB',
                        settings: { 'ga_red_toggle': $("#red_toggle_input").val(),
                                    'ga_red_toggle_status': $("#red_toggle_status_input").val(),
                                    'ga_red_dim': $("#red_dim_input").val(),
                                    'ga_red_dim_status': $("#red_dim_status_input").val(),
                                    'ga_green_toggle': $("#green_toggle_input").val(),
                                    'ga_green_toggle_status': $("#green_toggle_status_input").val(),
                                    'ga_green_dim': $("#green_dim_input").val(),
                                    'ga_green_dim_status': $("#green_dim_status_input").val(),
                                    'ga_blue_toggle': $("#blue_toggle_input").val(),
                                    'ga_blue_toggle_status': $("#blue_toggle_status_input").val(),
                                    'ga_blue_dim': $("#blue_dim_input").val(),
                                    'ga_blue_dim_status': $("#blue_dim_status_input").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'thermostat':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX Thermostat',
                        settings: { 'ga_temperature_target': $("#temperature_target_address").val(),
                                    'ga_temperature_measure': $("#temperature_measure_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'windowcovering':
                    Homey.addDevice({
                            data: {
                                id: deviceUuid
                            },
                            name: 'KNX Windowcovering',
                            settings: { 'ga_up_down': $("#windowcover_updown_address").val(),
                                        'ga_stop': $("#windowcover_stop_address").val(),
                                        'ga_status': $("#windowcover_status_address").val(),
                                        'macAddress': interfaceMAC
                            },
                        }, function(err, result) {
                            if(err) return Homey.alert(err);
                            Homey.done();
                        });
                    break;
                case 'sensor':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX Sensor',
                        settings: { 'ga_sensor': $("#sensor_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'scene':
                    Homey.addDevice({
                        data: {
                            id: deviceUuid
                        },
                        name: 'KNX Scene',
                        settings: { 'ga_scene': $("#scene_address").val(),
                                    'scene_number': $("#scene_number").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result) {
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
            }
            
        } else {
            Homey.alert(Homey.__('errors.save_error'), Homey.__('errors.ip.interface_not_selected'));
        }
    })

    // Check if there are uploaded groupaddresses available
    Homey.emit('list_etsimport', function(error, groupAddressList) {
        if(error) {
            console.log('ets error', error.message, error.toString());
            return Homey.alert(Homey.__('errors.generic_error'), error.message || error.toString());
        }
	    
        if(groupAddressList && groupAddressList.length > 0) {
            groupAddresses = groupAddressList;
            var $span = $('<span />').html(Homey.__('settings.projectfile.existingxml.title'))
            $xmlText.html($span);
            
            $('.knx-dropdown').each(function() {
                listGroupAddressesDropdown($(this));
            });
        }
        
        var $a = $('<a href="#">' + Homey.__('settings.projectfile.upload') + '</a>');
        $a.click(function(e){
            e.preventDefault();
			Homey.showView('parse_knxproj');
			return false;
        })
        $a.appendTo($xmlText);
    });
</script>