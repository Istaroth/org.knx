<!doctype html>
<div id="ga_input">
    <p data-i18n="settings.groupaddresses.body">
    </p>
    <fieldset id="knx-switch-fieldset" style="display: block">
        <div class="knx-switch field row">
            <label for="toggle_address" class="left" data-i18n="settings.groupaddresses.switch.toggle"></label>
            <select id="switchga_dropdown" class="knx-dropdown"></select>
            <input id="toggle_address" type="text" class="knx-text right">
            <label for="status_address" class="left" data-i18n="settings.groupaddresses.switch.status"></label>
            <select id="switchstatusga_dropdown" class="knx-dropdown"></select>
            <input id="status_address" type="text" class="knx-text right">
        </div>
    </fieldset>
    <fieldset id="knx-dimmer-fieldset" style="display: none">
        <div class="knx-dimmer field row">
            <label for="dim_address" class="left" data-i18n="settings.groupaddresses.dimmer.value"></label>
            <select id="dimga_dropdown" class="knx-dropdown"></select>
            <input id="dim_address" type="text" class="knx-text right">
            <label for="dim_status_address" class="left" data-i18n="settings.groupaddresses.dimmer.status"></label>
            <select id="dim_statusga_dropdown" class="knx-dropdown"></select>
            <input id="dim_status_address" type="text" class="knx-text right">
        </div>
    </fieldset>
    <fieldset id="knx-rgb-fieldset" style="display: none">
        <div class="knx-rgb field row">
            <label for="red_toggle_label" class="left" data-i18n="settings.groupaddresses.rgb.red_toggle_action"></label>
            <select id="red_toggle_dropdown" class="knx-dropdown"></select>
            <input id="red_toggle_input" type="text" class="knx-text right">
            <label for="red_toggle_status_label" class="left" data-i18n="settings.groupaddresses.rgb.red_toggle_status"></label>
            <select id="red_toggle_status_dropdown" class="knx-dropdown"></select>
            <input id="red_toggle_status_input" type="text" class="knx-text right">

            <label for="red_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.red_dim_value"></label>
            <select id="red_dim_dropdown" class="knx-dropdown"></select>
            <input id="red_dim_input" type="text" class="knx-text right">
            <label for="red_dim_status_label" class="left" data-i18n="settings.groupaddresses.rgb.red_dim_status"></label>
            <select id="red_dim_status_dropdown" class="knx-dropdown"></select>
            <input id="red_dim_status_input" type="text" class="knx-text right">
        </div>
        <div class="knx-rgb field row">
            <label for="green_toggle_label" class="left" data-i18n="settings.groupaddresses.rgb.green_toggle_action"></label>
            <select id="green_toggle_dropdown" class="knx-dropdown"></select>
            <input id="green_toggle_input" type="text" class="knx-text right">
            <label for="green_toggle_status_label" class="left" data-i18n="settings.groupaddresses.rgb.green_toggle_status"></label>
            <select id="green_toggle_status_dropdown" class="knx-dropdown"></select>
            <input id="green_toggle_status_input" type="text" class="knx-text right">

            <label for="green_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.green_dim_value"></label>
            <select id="green_dim_dropdown" class="knx-dropdown"></select>
            <input id="green_dim_input" type="text" class="knx-text right">
            <label for="green_dim_status_label" class="left" data-i18n="settings.groupaddresses.rgb.green_dim_status"></label>
            <select id="green_dim_status_dropdown" class="knx-dropdown"></select>
            <input id="green_dim_status_input" type="text" class="knx-text right">
        </div>
        <div class="knx-rgb field row">
            <label for="blue_toggle_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_toggle_action"></label>
            <select id="blue_toggle_dropdown" class="knx-dropdown"></select>
            <input id="blue_toggle_input" type="text" class="knx-text right">
            <label for="blue_toggle_status_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_toggle_status"></label>
            <select id="blue_toggle_status_dropdown" class="knx-dropdown"></select>
            <input id="blue_toggle_status_input" type="text" class="knx-text right">

            <label for="blue_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_dim_value"></label>
            <select id="blue_dim_dropdown" class="knx-dropdown"></select>
            <input id="blue_dim_input" type="text" class="knx-text right">
            <label for="blue_dim_status_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_dim_status"></label>
            <select id="blue_dim_status_dropdown" class="knx-dropdown"></select>
            <input id="blue_dim_status_input" type="text" class="knx-text right">
            </div>
        </fieldset>
        <fieldset id="knx-learnmode-fieldset" style="display: block">
            <label id="learnmode_label" data-i18n="settings.configmode.learnmode.explanation"></label>
            <button id="learnmode_button" class="right" data-i18n="settings.configmode.learnmode.title"></button>
            <select id="learnmode_dropdown" style="display: none"></select>
            <button id="test_button" class="right" data-i18n="settings.configmode.learnmode.testbutton"></button>
        </fieldset>
    <label id=xmltext data-i18n="settings.configmode.newxml.explanation"></label>
    <button id="button_newxml" class="right" data-i18n="settings.configmode.newxml.title"></button>
    <button id="save_button" class="right" data-i18n="settings.groupaddresses.save"></button>
</div>
<script>
    Homey.setTitle(Homey.__("settings.groupaddresses.body"));
    // Global variables
    var deviceType;
    var interfaceMAC;
    var groupAddresses;
    Homey.emit('return_selected_interface', function(error, macAddress) {
        interfaceMAC = macAddress;
        //console.log('MAC:', interfaceMAC);
    });

    Homey.getOptions(function(err, options) {
       deviceType = options.devicetype;
    });

    switch(deviceType) {
        case 'switch':
            console.log('device is a switch/lightbulb');
            break;
        case 'dimmer':
            console.log('device is a dimmer');
            $("#knx-dimmer-fieldset").css("display", "block");
            $("#knx-learnmode-fieldset").css("display", "none");
            break;
        case 'rgb':
            console.log('device is a rgb');
            $("#knx-switch-fieldset").css("display", "none");
            $("#knx-learnmode-fieldset").css("display", "none");
            $("#knx-rgb-fieldset").css("display", "block");
            break;
    }

    $learnmodeDropdown = $('#learnmode_dropdown');

    var $xmlText = $('#xmltext');

    // Helper functions

    function listGroupAddressesDropdown(selectItem, filter) {
        groupAddresses.forEach(function(etsEntry) {
            var optionEl = document.createElement("option");
            optionEl.value = etsEntry.address;
            optionEl.textContent = etsEntry.name + ", groupaddress: " + etsEntry.address;
            $(selectItem).append(optionEl);
        })
    }

    // Button acctions
    $('#button_newxml').on('click', function() {
        Homey.showView('parse_knxproj')
    });

    $('.knx-dropdown').on('change', function() {
        var value = $(this).val();
        $(this).next('.knx-text').val(value);
    })

    $('#learnmode_button').on('click', function() {
        $learnmodeDropdown.innerHTML = "";
        Homey.emit('learnmode', function(error, filteredList) {
            if(filteredList && filteredList.length > 0) {
                //console.log('learnmode list', filteredList);
                filteredList.forEach(function(event) {
                    var optionEl = document.createElement("option");
                    optionEl.value = event.destination;
                    optionEl.textContent = "Groupaddress " + event.destination;
                    $learnmodeDropdown.append(optionEl);
                });
                $("#learnmode_dropdown").css("display", "block");
                $("#toggle_address").val($learnmodeDropdown.val());
            }
        });
    });

    $("#test_button").on('click', function() {
        Homey.emit('test_groupaddress', $learnmodeDropdown.val(), function(error, result) {
            if(error) Homey.alert(error);
        });
        $("#toggle_address").val($learnmodeDropdown.val());
    });

    $("#save_button").on('click', function() {
        if(interfaceMAC) {
            console.log('Saving this device');
 
            switch(deviceType) {
                case 'switch':
                    Homey.addDevice({
                        data: {
                            id: $("#toggle_address").val()
                        },
                        name: 'KNX switch',
                        settings: { 'ga_switch': $("#toggle_address").val(),
                                    'ga_status': $("#status_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result){
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'dimmer':
                    Homey.addDevice({
                        data: {
                            id: $("#toggle_address").val()
                        },
                        name: 'KNX dimmer',
                        settings: { 'ga_switch': $("#toggle_address").val(),
                                    'ga_status': $("#status_address").val(),
                                    'ga_dim': $("#dim_address").val(),
                                    'ga_dim_status': $("#dim_status_address").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result){
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
                case 'rgb':
                    Homey.addDevice({
                        data: {
                            id: $("#ga_red_toggle").val()
                        },
                        name: 'KNX RGB',
                        settings: { 'ga_red_toggle': $("#red_toggle_input").val(),
                                    'ga_red_toggle_status': $("#red_toggle_status_input").val(),
                                    'ga_red_dim': $("#red_dim_input").val(),
                                    'ga_red_dim_status': $("#red_dim_status_input").val(),
                                    'ga_green_toggle': $("#green_toggle_input").val(),
                                    'ga_green_toggle_status': $("#green_toggle_status_input").val(),
                                    'ga_green_dim': $("#green_dim_input").val(),
                                    'ga_green_dim_status': $("#green_dim_status_input").val(),
                                    'ga_blue_toggle': $("#blue_toggle_input").val(),
                                    'ga_blue_toggle_status': $("#blue_toggle_status_input").val(),
                                    'ga_blue_dim': $("#blue_dim_input").val(),
                                    'ga_blue_dim_status': $("#blue_dim_status_input").val(),
                                    'macAddress': interfaceMAC
                        },
                    }, function(err, result){
                        if(err) return Homey.alert(err);
                        Homey.done();
                    });
                    break;
            }
            
        } else {
            Homey.alert('Cannot save device, no MAC address');
        }
    })

    // Check if there are uploaded groupaddresses available
    Homey.emit('list_etsimport', function(error, groupAddressList) {
        if(groupAddressList && groupAddressList.length > 0) {
            groupAddresses = groupAddressList;
            $xmlText[0].textContent = "A ETS export has already been uploaded for this interface.";
            $('.knx-dropdown').each(function() {
                listGroupAddressesDropdown($(this));
            });
        }
    });
</script>