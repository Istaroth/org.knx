<!doctype html>
<ul id="devices-list"></ul>
<div id="ip_input" style="display: none">
    <h1 data-i18n="settings.ip.title">
    </h1>
    <p data-i18n="settings.ip.body">
    </p>
    <fieldset>
        <legend data-i18n="settings.ip.singleip"></legend>
        <div class="field row">
            <label for="ip_address" data-i18n="settings.ip.interfaceaddress"></label>
            <input id="ip_address" type="text" value="" />
        </div>
        <button id="scan_button" class="left" data-i18n="settings.ip.scanbutton"></button>
        <button id="search_button" class="right" data-i18n="settings.ip.searchbutton"></button>
    </fieldset>
</div>

<script type="text/html" id="devices-list-template">
    <li class="device">
        <label for='device-{{:mac}}' class="name">
            <div class="overlay"></div>
            <input class="name" value="{{:name}} on IP: {{:ip}}" tabindex="-1" />
        </label>
        <label for='device-{{:mac}}' class="radio">
            <input id='device-{{:mac}}' data-mac='{{:mac}}' type="radio" name="device" value="{{:mac}}" tabindex="{{:#index+1}}" />
        </label>
    </li>
</script>
<script>
    Homey.setTitle(Homey.__("settings.ip.title"));
    function renderKNXInterfaceList(interfaceList) {
        var devices_render = $('#devices-list-template').render(interfaceList, {
            stringify: JSON.stringify
        });
        var $devList = $('#devices-list');
        $devList.html(devices_render);
        $devList.find(":radio").change(function(){
            console.log('selected', $(this).data('mac'));
            if ($(this).data('mac') === '0000000000') {
                console.log('User selected manual IP interface');
                $("#ip_input").css("display", "block");
            } else {
                console.log('Connect to the selected interface');
                $("#ip_input").css("display", "none");
                Homey.emit('selected_interface', $(this).data('mac'));
            }
        });
        if ($devList.children().length) {
            $($($devList.children()[0]).find(":radio")[0]).click();
        } else {
            $("#ip_input").css("display", "block");
        }
    }
    Homey.emit('list_interfaces', null, function(error, interfaceList) {
        interfaceList.push({name: 'Manual', mac:'0000000000'});
        renderKNXInterfaceList(interfaceList);
    });

    var $ipInput = $("#ip_address");
    var $searchButton = $("#search_button");
    $searchButton.on("click", function() {
        Homey.emit("manual_ip_address", $ipInput.val(), function(error, interfaceList){
            renderKNXInterfaceList(interfaceList);
        });
    });
</script>